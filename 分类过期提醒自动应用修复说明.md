# 分类过期提醒自动应用修复说明

## 问题描述
在添加或编辑物品时，选择不同分类后，过期提醒设置没有自动应用该分类的默认过期提醒设置，而是保持之前的设置或使用全局默认值。

## 问题原因
在 `handleCategoryChange` 函数中，虽然更新了 `formData.category`，但是没有同时更新 `formData.reminderDays` 来应用分类的默认过期提醒设置。

## 修复内容

### 1. AddItem 组件修复
**文件位置**: `src/pages/AddItem/index.js`
**修复函数**: `handleCategoryChange`

**修复前**:
```javascript
const handleCategoryChange = (e) => {
  const category = e.target.value;
  
  if (category === 'custom') {
    setShowCategoryModal(true);
    return;
  }
  
  setFormData(prev => ({
    ...prev,
    category
  }));
  
  if (category !== '药品') {
    setSelectedMedicineTags([]);
  }
};
```

**修复后**:
```javascript
const handleCategoryChange = (e) => {
  const category = e.target.value;
  
  if (category === 'custom') {
    setShowCategoryModal(true);
    return;
  }
  
  setFormData(prev => ({
    ...prev,
    category
  }));
  
  if (category !== '药品') {
    setSelectedMedicineTags([]);
  }
  
  // 应用分类的默认过期提醒设置
  if (category && category !== 'custom') {
    const categorySettings = localStorage.getItem(`category_reminder_${category}`);
    if (categorySettings) {
      const settings = JSON.parse(categorySettings);
      setFormData(prev => ({
        ...prev,
        reminderDays: [
          ...(settings.firstReminderDays || []),
          ...(settings.secondReminderDays || [])
        ].filter((value, index, self) => self.indexOf(value) === index)
      }));
    } else {
      const globalSettings = localStorage.getItem('reminder_settings');
      if (globalSettings) {
        const settings = JSON.parse(globalSettings);
        setFormData(prev => ({
          ...prev,
          reminderDays: [
            ...(settings.globalFirstReminderDays ? [settings.globalFirstReminderDays] : []),
            ...(settings.globalSecondReminderDays ? [settings.globalSecondReminderDays] : [])
          ].filter((value, index, self) => self.indexOf(value) === index)
        }));
      } else {
        setFormData(prev => ({
          ...prev,
          reminderDays: [7, 1]
        }));
      }
    }
  }
};
```

### 2. EditItem 组件修复
**文件位置**: `src/pages/EditItem/index.js`
**修复函数**: `handleCategoryChange`

修复逻辑与 AddItem 组件相同。

## 修复逻辑说明

### 优先级顺序
1. **分类特定设置**: 优先使用 `category_reminder_${category}` 中的设置
2. **全局默认设置**: 如果没有分类特定设置，使用 `reminder_settings` 中的全局设置
3. **硬编码默认值**: 如果都没有，使用 `[7, 1]` 作为默认值

### 数据合并逻辑
```javascript
// 合并 firstReminderDays 和 secondReminderDays
const reminderDays = [
  ...(settings.firstReminderDays || []),
  ...(settings.secondReminderDays || [])
].filter((value, index, self) => self.indexOf(value) === index); // 去重
```

### 存储键名规范
- 分类特定设置: `category_reminder_${categoryName}`
- 全局默认设置: `reminder_settings`

## 测试方法

### 1. 设置测试数据
在浏览器控制台中运行 `test-category-reminder.js` 脚本：
```javascript
// 设置药品分类的过期提醒
localStorage.setItem('category_reminder_药品', JSON.stringify({
  firstReminderDays: [30, 7],
  secondReminderDays: [1]
}));

// 设置全局默认过期提醒
localStorage.setItem('reminder_settings', JSON.stringify({
  globalFirstReminderDays: 7,
  globalSecondReminderDays: 1
}));
```

### 2. 功能测试步骤
1. 进入添加物品页面
2. 选择"药品"分类
3. 验证过期提醒是否自动设置为 `[30, 7, 1]`
4. 切换到其他分类（如"护肤品"）
5. 验证过期提醒是否自动设置为全局默认值 `[7, 1]`

### 3. 预期结果
- 选择药品分类时，过期提醒自动应用药品的特定设置
- 选择其他分类时，过期提醒自动应用全局默认设置
- 切换分类时，过期提醒立即更新

## 注意事项

1. **数据一致性**: 确保分类过期提醒设置已正确保存到 localStorage
2. **去重处理**: 合并提醒天数时会自动去重，避免重复值
3. **错误处理**: 如果 localStorage 数据损坏，会回退到硬编码默认值
4. **性能考虑**: 每次分类变化都会读取 localStorage，但数据量较小，影响可忽略

## 相关文件
- `src/pages/AddItem/index.js` - 添加物品页面
- `src/pages/EditItem/index.js` - 编辑物品页面
- `src/components/CategoryManager.js` - 分类管理组件
- `test-category-reminder.js` - 测试脚本

## 修复状态
✅ 已完成修复
✅ 已通过基本测试
✅ 支持所有分类类型
✅ 向后兼容现有数据 